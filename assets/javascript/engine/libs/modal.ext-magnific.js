'use strict';

/* --------------------------------------------------------------
 modal.js 2016-02-23 
 Gambio GmbH
 http://www.gambio.de
 Copyright (c) 2016 Gambio GmbH
 Released under the GNU General Public License (Version 2)
 [http://www.gnu.org/licenses/gpl-2.0.html]
 --------------------------------------------------------------
 */

jse.libs.template.modal = jse.libs.template.modal || {};
jse.libs.template.modal.magnific = jse.libs.template.modal.magnific || {};

/**
 * ## Honeygrid Modal Magnific (Library Extension)
 * 
 * Library-function to open default modal layer. This function depends on jQuery & jQuery UI.
 *
 * @module Honeygrid/Libs/modal.ext-magnific
 * @exports jse.libs.modal.ext-magnific
 * @ignore
 */
(function (exports) {
	'use strict';

	var $document = $(document),
	    $body = $('body');

	var _openLayer = function _openLayer(dataset, deferred, getFormData, originalOptions) {

		var $wrap = null,
		    $bg = null,
		    $buttons = null,
		    $closeX = null,
		    $forms = null,
		    promise = deferred.promise(),
		    instance = null,
		    defaults = {
			preloader: false
		},
		    options = $.extend({}, defaults, dataset),
		    uid = parseInt(Math.random() * 100000);

		// ADD BUTTON INFORMATION
		$.each(options.buttons, function (i, v) {
			options.showButtons = true;
			v.index = i;
			v.uid = uid;
		});

		// GENERATE LAYER
		options.items.src = Mustache.render($('#magnific_wrapper').html(), options);

		$.magnificPopup.open(options);
		instance = $.magnificPopup.instance;

		/**
  * Overwriting the instance previous() and next() methods
  * to prevent the tween effect due to
  * interferences with the swiper module
   */
		instance.prev = function () {
			return instance.content.find('.swiper-button-prev:first').click();
		};
		instance.next = function () {
			return instance.content.find('.swiper-button-next:first').click();
		};

		// GET SELECTIONS
		$wrap = $(instance.wrap);
		$bg = $(instance.bgOverlay);
		$buttons = $wrap.find('.modal-footer button');
		$closeX = $wrap.find('button.mfp-close');

		// ########## EVENT HANDLER ##########

		// REMOVE MAGNIFIC EVENT HANDLER
		$wrap.off('click.mfp');
		$bg.off('click.mfp');
		$document.off('keyup.mfp');

		// BIND BUTTON HANDLER
		$buttons.each(function () {
			var $self = $(this),
			    data = $self.data();

			if (typeof data.index === 'number') {
				$self.on('click', dataset.buttons[data.index].event);
			}
		});

		// BIND EVENT HANDLER FOR THE CLOSE BUTTON
		$closeX.off('click').on('click', function (e) {
			e.stopPropagation();
			_rejectHandler($wrap, deferred, getFormData);
		});

		// BIND EVENT HANDLER FOR BACKGROUND LAYER
		if (dataset.closeOnBgClick) {

			$wrap.off('click').on('click', function (e) {
				if (!$(e.target).closest('.modal-dialog').length) {
					_rejectHandler($wrap, deferred, getFormData);
				}
			});
		}

		// BIND CLOSE HANDLER FOR ESC-KEY
		if (dataset.enableEscapeKey) {

			$document.on('keyup.magnific', function (e) {
				if (e.keyCode === 27) {
					_rejectHandler($wrap, deferred, getFormData);
				}
			});
		}

		// ADD A CLOSE LAYER METHOD TO THE PROMISE
		// TODO: TESTING
		deferred.close = function (success) {
			if (success) {
				_resolveHandler($wrap, deferred, getFormData);
			} else {
				_rejectHandler($wrap, deferred, getFormData);
			}
		};

		// EXECUTE ADDITIONAL FUNCTION CODE ON LAYER OPEN
		if (options.executeCode && typeof options.executeCode === 'function') {
			options.executeCode.call($wrap);
		}

		if (originalOptions.bootstrapClass !== undefined) {
			$wrap.find('.modal-dialog').addClass(originalOptions.bootstrapClass);
		}

		if (originalOptions.zIndex !== undefined) {
			$wrap.css('z-index', originalOptions.zIndex);
		}

		jse.libs.template.modal.finalizeLayer($wrap, originalOptions);

		return promise;
	};

	var _convertTemplate = function _convertTemplate(key, value) {
		var newValue = {
			src: value,
			type: 'inline'
		};

		return ['items', newValue];
	};

	var _getMapper = function _getMapper() {
		return {
			dialogClass: 'mainClass',
			modal: false,
			closeOnEscape: 'enableEscapeKey',
			closeOnOuter: 'closeOnBgClick',
			closeX: 'showCloseBtn',
			storeTemplate: false,
			template: _convertTemplate
		};
	};

	var _rejectHandler = function _rejectHandler($element, deferred, getFormData) {
		$element = $element.closest('.mfp-wrap');
		getFormData($element).always(function (result) {
			$document.off('keyup.magnific');
			deferred.reject(result);
			$.magnificPopup.close();
		});
	};

	var _resolveHandler = function _resolveHandler($element, deferred, getFormData) {
		$element = $element.closest('.mfp-wrap');
		getFormData($element, true).done(function (result) {
			$document.off('keyup.magnific');
			deferred.resolve(result);
			$.magnificPopup.close();
		});
	};

	// ########## VARIABLE EXPORT ##########

	exports.openLayer = _openLayer;
	exports.getMapper = _getMapper;
	exports.getResolveHandler = _resolveHandler;
	exports.getRejectHandler = _rejectHandler;
})(jse.libs.template.modal.magnific);
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYnMvbW9kYWwuZXh0LW1hZ25pZmljLmpzIl0sIm5hbWVzIjpbImpzZSIsImxpYnMiLCJ0ZW1wbGF0ZSIsIm1vZGFsIiwibWFnbmlmaWMiLCJleHBvcnRzIiwiJGRvY3VtZW50IiwiJCIsImRvY3VtZW50IiwiJGJvZHkiLCJfb3BlbkxheWVyIiwiZGF0YXNldCIsImRlZmVycmVkIiwiZ2V0Rm9ybURhdGEiLCJvcmlnaW5hbE9wdGlvbnMiLCIkd3JhcCIsIiRiZyIsIiRidXR0b25zIiwiJGNsb3NlWCIsIiRmb3JtcyIsInByb21pc2UiLCJpbnN0YW5jZSIsImRlZmF1bHRzIiwicHJlbG9hZGVyIiwib3B0aW9ucyIsImV4dGVuZCIsInVpZCIsInBhcnNlSW50IiwiTWF0aCIsInJhbmRvbSIsImVhY2giLCJidXR0b25zIiwiaSIsInYiLCJzaG93QnV0dG9ucyIsImluZGV4IiwiaXRlbXMiLCJzcmMiLCJNdXN0YWNoZSIsInJlbmRlciIsImh0bWwiLCJtYWduaWZpY1BvcHVwIiwib3BlbiIsInByZXYiLCJjb250ZW50IiwiZmluZCIsImNsaWNrIiwibmV4dCIsIndyYXAiLCJiZ092ZXJsYXkiLCJvZmYiLCIkc2VsZiIsImRhdGEiLCJvbiIsImV2ZW50IiwiZSIsInN0b3BQcm9wYWdhdGlvbiIsIl9yZWplY3RIYW5kbGVyIiwiY2xvc2VPbkJnQ2xpY2siLCJ0YXJnZXQiLCJjbG9zZXN0IiwibGVuZ3RoIiwiZW5hYmxlRXNjYXBlS2V5Iiwia2V5Q29kZSIsImNsb3NlIiwic3VjY2VzcyIsIl9yZXNvbHZlSGFuZGxlciIsImV4ZWN1dGVDb2RlIiwiY2FsbCIsImJvb3RzdHJhcENsYXNzIiwidW5kZWZpbmVkIiwiYWRkQ2xhc3MiLCJ6SW5kZXgiLCJjc3MiLCJmaW5hbGl6ZUxheWVyIiwiX2NvbnZlcnRUZW1wbGF0ZSIsImtleSIsInZhbHVlIiwibmV3VmFsdWUiLCJ0eXBlIiwiX2dldE1hcHBlciIsImRpYWxvZ0NsYXNzIiwiY2xvc2VPbkVzY2FwZSIsImNsb3NlT25PdXRlciIsImNsb3NlWCIsInN0b3JlVGVtcGxhdGUiLCIkZWxlbWVudCIsImFsd2F5cyIsInJlc3VsdCIsInJlamVjdCIsImRvbmUiLCJyZXNvbHZlIiwib3BlbkxheWVyIiwiZ2V0TWFwcGVyIiwiZ2V0UmVzb2x2ZUhhbmRsZXIiLCJnZXRSZWplY3RIYW5kbGVyIl0sIm1hcHBpbmdzIjoiOztBQUFBOzs7Ozs7Ozs7O0FBVUFBLElBQUlDLElBQUosQ0FBU0MsUUFBVCxDQUFrQkMsS0FBbEIsR0FBMEJILElBQUlDLElBQUosQ0FBU0MsUUFBVCxDQUFrQkMsS0FBbEIsSUFBMkIsRUFBckQ7QUFDQUgsSUFBSUMsSUFBSixDQUFTQyxRQUFULENBQWtCQyxLQUFsQixDQUF3QkMsUUFBeEIsR0FBbUNKLElBQUlDLElBQUosQ0FBU0MsUUFBVCxDQUFrQkMsS0FBbEIsQ0FBd0JDLFFBQXhCLElBQW9DLEVBQXZFOztBQUVBOzs7Ozs7Ozs7QUFTQyxXQUFTQyxPQUFULEVBQWtCO0FBQ2xCOztBQUVBLEtBQUlDLFlBQVlDLEVBQUVDLFFBQUYsQ0FBaEI7QUFBQSxLQUNDQyxRQUFRRixFQUFFLE1BQUYsQ0FEVDs7QUFHQSxLQUFJRyxhQUFhLFNBQWJBLFVBQWEsQ0FBU0MsT0FBVCxFQUFrQkMsUUFBbEIsRUFBNEJDLFdBQTVCLEVBQXlDQyxlQUF6QyxFQUEwRDs7QUFFMUUsTUFBSUMsUUFBUSxJQUFaO0FBQUEsTUFDQ0MsTUFBTSxJQURQO0FBQUEsTUFFQ0MsV0FBVyxJQUZaO0FBQUEsTUFHQ0MsVUFBVSxJQUhYO0FBQUEsTUFJQ0MsU0FBUyxJQUpWO0FBQUEsTUFLQ0MsVUFBVVIsU0FBU1EsT0FBVCxFQUxYO0FBQUEsTUFNQ0MsV0FBVyxJQU5aO0FBQUEsTUFPQ0MsV0FBVztBQUNWQyxjQUFXO0FBREQsR0FQWjtBQUFBLE1BVUNDLFVBQVVqQixFQUFFa0IsTUFBRixDQUFTLEVBQVQsRUFBYUgsUUFBYixFQUF1QlgsT0FBdkIsQ0FWWDtBQUFBLE1BV0NlLE1BQU1DLFNBQVNDLEtBQUtDLE1BQUwsS0FBZ0IsTUFB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RDs7QUFZQSxLQUFJbEIsaUJBQWlCLFNBQWpCQSxjQUFpQixDQUFTNkIsUUFBVCxFQUFtQjFFLFFBQW5CLEVBQTZCQyxXQUE3QixFQUEwQztBQUM5RHlFLGFBQVdBLFNBQVMxQixPQUFULENBQWlCLFdBQWpCLENBQVg7QUFDQS9DLGNBQVl5RSxRQUFaLEVBQXNCQyxNQUF0QixDQUE2QixVQUFTQyxNQUFULEVBQWlCO0FBQzdDbEYsYUFBVTRDLEdBQVYsQ0FBYyxnQkFBZDtBQUNBdEMsWUFBUzZFLE1BQVQsQ0FBZ0JELE1BQWhCO0FBQ0FqRixLQUFFa0MsYUFBRixDQUFnQnVCLEtBQWhCO0FBQ0EsR0FKRDtBQUtBLEVBUEQ7O0FBU0EsS0FBSUUsa0JBQWtCLFNBQWxCQSxlQUFrQixDQUFTb0IsUUFBVCxFQUFtQjFFLFFBQW5CLEVBQTZCQyxXQUE3QixFQUEwQztBQUMvRHlFLGFBQVdBLFNBQVMxQixPQUFULENBQWlCLFdBQWpCLENBQVg7QUFDQS9DLGNBQVl5RSxRQUFaLEVBQXNCLElBQXRCLEVBQTRCSSxJQUE1QixDQUFpQyxVQUFTRixNQUFULEVBQWlCO0FBQ2pEbEYsYUFBVTRDLEdBQVYsQ0FBYyxnQkFBZDtBQUNBdEMsWUFBUytFLE9BQVQsQ0FBaUJILE1BQWpCO0FBQ0FqRixLQUFFa0MsYUFBRixDQUFnQnVCLEtBQWhCO0FBQ0EsR0FKRDtBQUtBLEVBUEQ7O0FBVUQ7O0FBRUMzRCxTQUFRdUYsU0FBUixHQUFvQmxGLFVBQXBCO0FBQ0FMLFNBQVF3RixTQUFSLEdBQW9CYixVQUFwQjtBQUNBM0UsU0FBUXlGLGlCQUFSLEdBQTRCNUIsZUFBNUI7QUFDQTdELFNBQVEwRixnQkFBUixHQUEyQnRDLGNBQTNCO0FBRUEsQ0EvS0EsRUErS0N6RCxJQUFJQyxJQUFKLENBQVNDLFFBQVQsQ0FBa0JDLEtBQWxCLENBQXdCQyxRQS9LekIsQ0FBRCIsImZpbGUiOiJsaWJzL21vZGFsLmV4dC1tYWduaWZpYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gbW9kYWwuanMgMjAxNi0wMi0yMyBcbiBHYW1iaW8gR21iSFxuIGh0dHA6Ly93d3cuZ2FtYmlvLmRlXG4gQ29weXJpZ2h0IChjKSAyMDE2IEdhbWJpbyBHbWJIXG4gUmVsZWFzZWQgdW5kZXIgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIChWZXJzaW9uIDIpXG4gW2h0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9ncGwtMi4wLmh0bWxdXG4gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAqL1xuXG5qc2UubGlicy50ZW1wbGF0ZS5tb2RhbCA9IGpzZS5saWJzLnRlbXBsYXRlLm1vZGFsIHx8IHt9O1xuanNlLmxpYnMudGVtcGxhdGUubW9kYWwubWFnbmlmaWMgPSBqc2UubGlicy50ZW1wbGF0ZS5tb2RhbC5tYWduaWZpYyB8fCB7fTtcblxuLyoqXG4gKiAjIyBIb25leWdyaWQgTW9kYWwgTWFnbmlmaWMgKExpYnJhcnkgRXh0ZW5zaW9uKVxuICogXG4gKiBMaWJyYXJ5LWZ1bmN0aW9uIHRvIG9wZW4gZGVmYXVsdCBtb2RhbCBsYXllci4gVGhpcyBmdW5jdGlvbiBkZXBlbmRzIG9uIGpRdWVyeSAmIGpRdWVyeSBVSS5cbiAqXG4gKiBAbW9kdWxlIEhvbmV5Z3JpZC9MaWJzL21vZGFsLmV4dC1tYWduaWZpY1xuICogQGV4cG9ydHMganNlLmxpYnMubW9kYWwuZXh0LW1hZ25pZmljXG4gKiBAaWdub3JlXG4gKi9cbihmdW5jdGlvbihleHBvcnRzKSB7XG5cdCd1c2Ugc3RyaWN0JztcblxuXHR2YXIgJGRvY3VtZW50ID0gJChkb2N1bWVudCksXG5cdFx0JGJvZHkgPSAkKCdib2R5Jyk7XG5cblx0dmFyIF9vcGVuTGF5ZXIgPSBmdW5jdGlvbihkYXRhc2V0LCBkZWZlcnJlZCwgZ2V0Rm9ybURhdGEsIG9yaWdpbmFsT3B0aW9ucykge1xuXG5cdFx0dmFyICR3cmFwID0gbnVsbCxcblx0XHRcdCRiZyA9IG51bGwsXG5cdFx0XHQkYnV0dG9ucyA9IG51bGwsXG5cdFx0XHQkY2xvc2VYID0gbnVsbCxcblx0XHRcdCRmb3JtcyA9IG51bGwsXG5cdFx0XHRwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSgpLFxuXHRcdFx0aW5zdGFuY2UgPSBudWxsLFxuXHRcdFx0ZGVmYXVsdHMgPSB7XG5cdFx0XHRcdHByZWxvYWRlcjogZmFsc2Vcblx0XHRcdH0sXG5cdFx0XHRvcHRpb25zID0gJC5leHRlbmQoe30sIGRlZmF1bHRzLCBkYXRhc2V0KSxcblx0XHRcdHVpZCA9IHBhcnNlSW50KE1hdGgucmFuZG9tKCkgKiAxMDAwMDApO1xuXG5cdFx0Ly8gQUREIEJVVFRPTiBJTkZPUk1BVElPTlxuXHRcdCQuZWFjaChvcHRpb25zLmJ1dHRvbnMsIGZ1bmN0aW9uKGksIHYpIHtcblx0XHRcdG9wdGlvbnMuc2hvd0J1dHRvbnMgPSB0cnVlO1xuXHRcdFx0di5pbmRleCA9IGk7XG5cdFx0XHR2LnVpZCA9IHVpZDtcblx0XHR9KTtcblxuXHRcdC8vIEdFTkVSQVRFIExBWUVSXG5cdFx0b3B0aW9ucy5pdGVtcy5zcmMgPSBNdXN0YWNoZS5yZW5kZXIoJCgnI21hZ25pZmljX3dyYXBwZXInKS5odG1sKCksIG9wdGlvbnMpO1xuXG5cdFx0JC5tYWduaWZpY1BvcHVwLm9wZW4ob3B0aW9ucyk7XG5cdFx0aW5zdGFuY2UgPSAkLm1hZ25pZmljUG9wdXAuaW5zdGFuY2U7XG5cbiAgICAgICAgLyoqXG5cdFx0ICogT3ZlcndyaXRpbmcgdGhlIGluc3RhbmNlIHByZXZpb3VzKCkgYW5kIG5leHQoKSBtZXRob2RzXG5cdFx0ICogdG8gcHJldmVudCB0aGUgdHdlZW4gZWZmZWN0IGR1ZSB0b1xuXHRcdCAqIGludGVyZmVyZW5jZXMgd2l0aCB0aGUgc3dpcGVyIG1vZHVsZVxuICAgICAgICAgKi9cbiAgICAgICAgaW5zdGFuY2UucHJldiA9ICgpID0+IGluc3RhbmNlLmNvbnRlbnQuZmluZCgnLnN3aXBlci1idXR0b24tcHJldjpmaXJzdCcpLmNsaWNrKCk7XG4gICAgICAgIGluc3RhbmNlLm5leHQgPSAoKSA9PiBpbnN0YW5jZS5jb250ZW50LmZpbmQoJy5zd2lwZXItYnV0dG9uLW5leHQ6Zmlyc3QnKS5jbGljaygpO1xuXG5cdFx0Ly8gR0VUIFNFTEVDVElPTlNcblx0XHQkd3JhcCA9ICQoaW5zdGFuY2Uud3JhcCk7XG5cdFx0JGJnID0gJChpbnN0YW5jZS5iZ092ZXJsYXkpO1xuXHRcdCRidXR0b25zID0gJHdyYXAuZmluZCgnLm1vZGFsLWZvb3RlciBidXR0b24nKTtcblx0XHQkY2xvc2VYID0gJHdyYXAuZmluZCgnYnV0dG9uLm1mcC1jbG9zZScpO1xuXG4vLyAjIyMjIyMjIyMjIEVWRU5UIEhBTkRMRVIgIyMjIyMjIyMjI1xuXG5cdFx0Ly8gUkVNT1ZFIE1BR05JRklDIEVWRU5UIEhBTkRMRVJcblx0XHQkd3JhcC5vZmYoJ2NsaWNrLm1mcCcpO1xuXHRcdCRiZy5vZmYoJ2NsaWNrLm1mcCcpO1xuXHRcdCRkb2N1bWVudC5vZmYoJ2tleXVwLm1mcCcpO1xuXG5cblx0XHQvLyBCSU5EIEJVVFRPTiBIQU5ETEVSXG5cdFx0JGJ1dHRvbnMuZWFjaChmdW5jdGlvbigpIHtcblx0XHRcdHZhciAkc2VsZiA9ICQodGhpcyksXG5cdFx0XHRcdGRhdGEgPSAkc2VsZi5kYXRhKCk7XG5cblx0XHRcdGlmICh0eXBlb2YgZGF0YS5pbmRleCA9PT0gJ251bWJlcicpIHtcblx0XHRcdFx0JHNlbGYub24oJ2NsaWNrJywgZGF0YXNldC5idXR0b25zW2RhdGEuaW5kZXhdLmV2ZW50KTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdC8vIEJJTkQgRVZFTlQgSEFORExFUiBGT1IgVEhFIENMT1NFIEJVVFRPTlxuXHRcdCRjbG9zZVhcblx0XHRcdC5vZmYoJ2NsaWNrJylcblx0XHRcdC5vbignY2xpY2snLCBmdW5jdGlvbihlKSB7XG5cdFx0XHRcdGUuc3RvcFByb3BhZ2F0aW9uKCk7XG5cdFx0XHRcdF9yZWplY3RIYW5kbGVyKCR3cmFwLCBkZWZlcnJlZCwgZ2V0Rm9ybURhdGEpO1xuXHRcdFx0fSk7XG5cblx0XHQvLyBCSU5EIEVWRU5UIEhBTkRMRVIgRk9SIEJBQ0tHUk9VTkQgTEFZRVJcblx0XHRpZiAoZGF0YXNldC5jbG9zZU9uQmdDbGljaykge1xuXG5cdFx0XHQkd3JhcFxuXHRcdFx0XHQub2ZmKCdjbGljaycpXG5cdFx0XHRcdC5vbignY2xpY2snLCBmdW5jdGlvbihlKSB7XG5cdFx0XHRcdFx0aWYgKCEkKGUudGFyZ2V0KS5jbG9zZXN0KCcubW9kYWwtZGlhbG9nJykubGVuZ3RoKSB7XG5cdFx0XHRcdFx0XHRfcmVqZWN0SGFuZGxlcigkd3JhcCwgZGVmZXJyZWQsIGdldEZvcm1EYXRhKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXG5cdFx0fVxuXG5cdFx0Ly8gQklORCBDTE9TRSBIQU5ETEVSIEZPUiBFU0MtS0VZXG5cdFx0aWYgKGRhdGFzZXQuZW5hYmxlRXNjYXBlS2V5KSB7XG5cblx0XHRcdCRkb2N1bWVudFxuXHRcdFx0XHQub24oJ2tleXVwLm1hZ25pZmljJywgZnVuY3Rpb24oZSkge1xuXHRcdFx0XHRcdGlmIChlLmtleUNvZGUgPT09IDI3KSB7XG5cdFx0XHRcdFx0XHRfcmVqZWN0SGFuZGxlcigkd3JhcCwgZGVmZXJyZWQsIGdldEZvcm1EYXRhKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXG5cdFx0fVxuXG5cdFx0Ly8gQUREIEEgQ0xPU0UgTEFZRVIgTUVUSE9EIFRPIFRIRSBQUk9NSVNFXG5cdFx0Ly8gVE9ETzogVEVTVElOR1xuXHRcdGRlZmVycmVkLmNsb3NlID0gZnVuY3Rpb24oc3VjY2Vzcykge1xuXHRcdFx0aWYgKHN1Y2Nlc3MpIHtcblx0XHRcdFx0X3Jlc29sdmVIYW5kbGVyKCR3cmFwLCBkZWZlcnJlZCwgZ2V0Rm9ybURhdGEpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0X3JlamVjdEhhbmRsZXIoJHdyYXAsIGRlZmVycmVkLCBnZXRGb3JtRGF0YSk7XG5cdFx0XHR9XG5cdFx0fTtcblxuXHRcdC8vIEVYRUNVVEUgQURESVRJT05BTCBGVU5DVElPTiBDT0RFIE9OIExBWUVSIE9QRU5cblx0XHRpZiAob3B0aW9ucy5leGVjdXRlQ29kZSAmJiB0eXBlb2Ygb3B0aW9ucy5leGVjdXRlQ29kZSA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0b3B0aW9ucy5leGVjdXRlQ29kZS5jYWxsKCR3cmFwKTtcblx0XHR9XG5cblxuXHRcdGlmIChvcmlnaW5hbE9wdGlvbnMuYm9vdHN0cmFwQ2xhc3MgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0JHdyYXAuZmluZCgnLm1vZGFsLWRpYWxvZycpLmFkZENsYXNzKG9yaWdpbmFsT3B0aW9ucy5ib290c3RyYXBDbGFzcyk7XG5cdFx0fVxuXG5cdFx0aWYgKG9yaWdpbmFsT3B0aW9ucy56SW5kZXggIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0JHdyYXAuY3NzKCd6LWluZGV4Jywgb3JpZ2luYWxPcHRpb25zLnpJbmRleCk7XG5cdFx0fVxuXG5cdFx0anNlLmxpYnMudGVtcGxhdGUubW9kYWwuZmluYWxpemVMYXllcigkd3JhcCwgb3JpZ2luYWxPcHRpb25zKTtcblxuXHRcdHJldHVybiBwcm9taXNlO1xuXHR9O1xuXG5cdHZhciBfY29udmVydFRlbXBsYXRlID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSkge1xuXHRcdHZhciBuZXdWYWx1ZSA9IHtcblx0XHRcdHNyYzogdmFsdWUsXG5cdFx0XHR0eXBlOiAnaW5saW5lJ1xuXHRcdH07XG5cblx0XHRyZXR1cm4gWydpdGVtcycsIG5ld1ZhbHVlXTtcblx0fTtcblxuXHR2YXIgX2dldE1hcHBlciA9IGZ1bmN0aW9uKCkge1xuXHRcdHJldHVybiB7XG5cdFx0XHRkaWFsb2dDbGFzczogJ21haW5DbGFzcycsXG5cdFx0XHRtb2RhbDogZmFsc2UsXG5cdFx0XHRjbG9zZU9uRXNjYXBlOiAnZW5hYmxlRXNjYXBlS2V5Jyxcblx0XHRcdGNsb3NlT25PdXRlcjogJ2Nsb3NlT25CZ0NsaWNrJyxcblx0XHRcdGNsb3NlWDogJ3Nob3dDbG9zZUJ0bicsXG5cdFx0XHRzdG9yZVRlbXBsYXRlOiBmYWxzZSxcblx0XHRcdHRlbXBsYXRlOiBfY29udmVydFRlbXBsYXRlXG5cdFx0fTtcblx0fTtcblxuXHR2YXIgX3JlamVjdEhhbmRsZXIgPSBmdW5jdGlvbigkZWxlbWVudCwgZGVmZXJyZWQsIGdldEZvcm1EYXRhKSB7XG5cdFx0JGVsZW1lbnQgPSAkZWxlbWVudC5jbG9zZXN0KCcubWZwLXdyYXAnKTtcblx0XHRnZXRGb3JtRGF0YSgkZWxlbWVudCkuYWx3YXlzKGZ1bmN0aW9uKHJlc3VsdCkge1xuXHRcdFx0JGRvY3VtZW50Lm9mZigna2V5dXAubWFnbmlmaWMnKTtcblx0XHRcdGRlZmVycmVkLnJlamVjdChyZXN1bHQpO1xuXHRcdFx0JC5tYWduaWZpY1BvcHVwLmNsb3NlKCk7XG5cdFx0fSk7XG5cdH07XG5cblx0dmFyIF9yZXNvbHZlSGFuZGxlciA9IGZ1bmN0aW9uKCRlbGVtZW50LCBkZWZlcnJlZCwgZ2V0Rm9ybURhdGEpIHtcblx0XHQkZWxlbWVudCA9ICRlbGVtZW50LmNsb3Nlc3QoJy5tZnAtd3JhcCcpO1xuXHRcdGdldEZvcm1EYXRhKCRlbGVtZW50LCB0cnVlKS5kb25lKGZ1bmN0aW9uKHJlc3VsdCkge1xuXHRcdFx0JGRvY3VtZW50Lm9mZigna2V5dXAubWFnbmlmaWMnKTtcblx0XHRcdGRlZmVycmVkLnJlc29sdmUocmVzdWx0KTtcblx0XHRcdCQubWFnbmlmaWNQb3B1cC5jbG9zZSgpO1xuXHRcdH0pO1xuXHR9O1xuXG5cbi8vICMjIyMjIyMjIyMgVkFSSUFCTEUgRVhQT1JUICMjIyMjIyMjIyNcblxuXHRleHBvcnRzLm9wZW5MYXllciA9IF9vcGVuTGF5ZXI7XG5cdGV4cG9ydHMuZ2V0TWFwcGVyID0gX2dldE1hcHBlcjtcblx0ZXhwb3J0cy5nZXRSZXNvbHZlSGFuZGxlciA9IF9yZXNvbHZlSGFuZGxlcjtcblx0ZXhwb3J0cy5nZXRSZWplY3RIYW5kbGVyID0gX3JlamVjdEhhbmRsZXI7XG5cbn0oanNlLmxpYnMudGVtcGxhdGUubW9kYWwubWFnbmlmaWMpKTsiXX0=
