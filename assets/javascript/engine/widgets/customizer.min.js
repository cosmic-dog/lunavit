"use strict";gambio.widgets.module("customizer",[jse.source+"/vendor/jquery-ui/jquery-ui.min.js",gambio.source+"/libs/events"],function(e){var t=$(this),r=$("body"),i=$(window),d=null,n={requestUrl:"request_port.php?module=GPrint",uidSelector:"#gm_gprint_random",page:"product"},a=$.extend(!0,{},n,e),o={},s=function(e,r){var i=jse.libs.form.getData(t,null,!0),d=$.extend({mode:"frontend",action:e.data.action},r.dataset,{},i),n=[],a="";$('.customizer select[name^="id["], .customizer input[name^="id["]:checked').each(function(){var e=$(this).attr("name").replace(/id\[(\d+)\]/,"$1");a+="{"+e+"}"+$(this).val()}),d.products_id=d.products_id+a+"{"+e.data.random.match(/\d+/)+"}0",t.find('input[type="file"]').each(function(){if($(this).get(0).files.length>0){var e=$.Deferred();n.push(e),$(this).hide(),$(this).parent().append('<img src="gm/images/gprint/upload.gif" width="16" height="11" class="gm_gprint_loading" id="loading_'+$(this).attr("id")+'" />'),l($(this),d,e)}}),n.length?$.when.apply(void 0,n).done(function(){u(e,r,d)}).always(function(){}):u(e,r,d)},l=function(e,t,r){var i=e.get(0).files,d=a.requestUrl+"&action=upload&target="+t.target+"&mode=frontend&upload_field_id="+e.attr("id")+"&products_id="+t.products_id;$('.customizer select[name^="properties_values_ids["]').each(function(){d+="&properties_values_ids[]="+$(this).val()}),e.fileupload({url:d,autoUpload:!1,dataType:"json"}),e.fileupload("send",{files:i}).done(function(i){var d=e.attr("id"),n=e.val().replace(/C:\\fakepath\\/i,"");t[d]=n,e.parent().find("img").remove(),e.show(),i.ERROR?(alert(i.ERROR_MESSAGE),r.reject()):r.resolve(i)}).fail(function(t,i,d){e.parent().find("img").remove(),e.show(),r.reject()})},u=function(e,t,r){d=d?d.abort():null,d=jse.libs.xhr.post({url:a.requestUrl,data:r},!0),d.done(function(){t.deferred&&t.deferred.resolve(e.data.random)}).fail(function(){t.deferred&&t.deferred.reject()})},c=function(e,t){return t.dataset.products_id[0].indexOf("}0")===-1?void(t.deferred&&t.deferred.resolve()):(d=d?d.abort():null,d=jse.libs.xhr.post({url:a.requestUrl,data:{action:"wishlist_to_cart",products_id:t.dataset.products_id[0],mode:"frontend"}},!0),void d.done(function(){t.deferred&&t.deferred.resolve()}).fail(function(){t.deferred&&t.deferred.reject()}))},f=function(e,t){if(t.dataset.products_id[0].indexOf("}0")===-1)return void(t.deferred&&t.deferred.resolve());var r="update_wishlist";"cart"===a.page&&(r="update_cart"),d=d?d.abort():null,d=jse.libs.xhr.post({url:a.requestUrl,data:{action:r,products_id:t.dataset.products_id[0],mode:"frontend"}},!0),d.done(function(){t.deferred&&t.deferred.resolve()}).fail(function(){t.deferred&&t.deferred.reject()})};return o.init=function(e){if("product"===a.page){var t=$(a.uidSelector).attr("name");r.on(jse.libs.template.events.ADD_CUSTOMIZER_CART(),{action:"add_cart",target:"cart",random:t},s),r.on(jse.libs.template.events.ADD_CUSTOMIZER_WISHLIST(),{action:"add_wishlist",target:"wishlist",random:t},s)}r.on(jse.libs.template.events.WISHLIST_TO_CART(),c),r.on(jse.libs.template.events.WISHLIST_CART_DELETE(),f),$("#gm_gprint_tabs li").on("click",function(){i.trigger(jse.libs.template.events.STICKYBOX_CONTENT_CHANGE())}),i.trigger(jse.libs.template.events.STICKYBOX_CONTENT_CHANGE());var d=[jse.source+"/vendor/blueimp-file-upload/jquery.fileupload.min.js"];window.require(d,e)},o});