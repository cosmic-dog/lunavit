"use strict";gambio.widgets.module("cart_handler",["hooks","form","xhr",gambio.source+"/libs/events",gambio.source+"/libs/modal.ext-magnific",gambio.source+"/libs/modal"],function(e){var t=$(this),s=$("body"),a=$(window),i=!1,r=null,o=0,n={addCartUrl:"shop.php?do=Cart/BuyProduct",addCartCustomizerUrl:"shop.php?do=Cart/Add",checkUrl:"shop.php?do=CheckStatus",wishlistUrl:"shop.php?do=WishList/Add",priceOfferUrl:"gm_price_offer.php",priceOfferMethod:"get",dropdown:"#head_shopping_cart",cartButtons:".js-btn-add-to-cart",wishlistButtons:".btn-wishlist",priceOfferButtons:".btn-price-offer",attributes:".js-calculate",quantity:".js-calculate-qty",tpl:null,attributImagesSwiper:!1,triggerAttrImagesTo:"#product_image_swiper, #product_thumbnail_swiper, #product_thumbnail_swiper_mobile",processingClass:"loading",processingDuration:2e3,selectorMapping:{attributeImages:".attribute-images",buttons:".shopping-cart-button",giftContent:".gift-cart-content-wrapper",giftLayer:".gift-cart-layer",shareContent:".share-cart-content-wrapper",shareLayer:".share-cart-layer",hiddenOptions:"#cart_quantity .hidden-options",message:".global-error-messages",messageCart:".cart-error-msg",messageHelp:".help-block",modelNumber:".model-number",price:".current-price-container",propertiesForm:".properties-selection-form",quantity:".products-quantity-value",ribbonSpecial:".ribbon-special",shippingInformation:"#shipping-information-layer",shippingTime:".products-shipping-time-value",shippingTimeImage:".img-shipping-time img",totals:"#cart_quantity .total-box",weight:".products-details-weight-container span"}},c=$.extend(!0,{},n,e),l={},u=function(e,t){var s=setTimeout(function(){e.removeClass(c.processingClass+" "+c.processingClass+t)},c.processingDuration);e.data("timer",s).addClass(c.processingClass+t)},d=function(e,t,s,i){if(c.attributImagesSwiper&&e.attrImages&&e.attrImages.length&&(delete e.content.images,$(c.triggerAttrImagesTo).trigger(jse.libs.template.events.SLIDES_UPDATE(),{attributes:e.attrImages})),$.each(e.content,function(e,s){var a=t.parent().find(c.selectorMapping[s.selector]);if((!i||""===s.value)&&"messageNoCombiSelected"===e)return!0;switch(s.type){case"html":a.html(s.value);break;case"attribute":a.attr(s.key,s.value);break;case"replace":s.value?a.replaceWith(s.value):a.addClass("hidden").empty();break;default:a.text(s.value)}}),s){var r=t.find(c.cartButtons);e.success?(r.removeClass("inactive"),r.removeClass("btn-inactive")):(r.addClass("inactive"),r.addClass("btn-inactive"))}if(e.content.message){var o=t.find(c.selectorMapping[e.content.message.selector]);e.content.message.value?o.removeClass("hidden").show():(o.addClass("hidden").hide(),i&&void 0!==e.content.messageNoCombiSelected&&e.content.messageNoCombiSelected&&(e.content.messageNoCombiSelected.value?o.removeClass("hidden").show():o.addClass("hidden").hide()))}a.trigger(jse.libs.template.events.STICKYBOX_CONTENT_CHANGE())},p=function(e,t,a,r){function o(){jse.libs.xhr.post({url:a,data:e},!0).done(function(e){try{if(d(e,t,!1),e.success)switch(e.type){case"url":"http"!==e.url.substr(0,4)?location.href=jse.core.config.get("appUrl")+"/"+e.url:location.href=e.url;break;case"dropdown":s.trigger(jse.libs.template.events.CART_UPDATE(),[!0]);break;case"layer":jse.libs.template.modal.info({title:e.title,content:e.msg})}}catch(a){}u(r,"-success")}).fail(function(){u(r,"-fail")}).always(function(){i=!1})}i||(i=!0,jse.libs.hooks.execute(jse.libs.hooks.keys.shop.cart.add,e,500).then(o)["catch"](o))},g=function(e){e&&e.preventDefault();var i=$(this),o=i.is("form")?i:i.closest("form"),n=o.hasClass("customizer"),l=!!o.find(".properties-selection-form").length,g=l?"":"/Attributes",m=e&&e.data&&e.data.target&&"check"!==e.data.target;if(o.length){l&&t.addClass("loading");var h=jse.libs.form.getData(o,null,!0);if(h.target=e&&e.data&&e.data.target?e.data.target:"check",h.isProductInfo=o.hasClass("product-info")?1:0,r&&e&&r.abort(),"check"!==h.target){var f=i.data("timer");f&&clearTimeout(f),i.removeClass(c.processingClass+"-success "+c.processingClass+"-fail").addClass(c.processingClass)}r=jse.libs.xhr.get({url:c.checkUrl+g,data:h},!0).done(function(e){if(d(e,o,!0,m),t.removeClass("loading"),e.success){var r=null,l=null;switch(h.target){case"wishlist":n&&(r=jse.libs.template.events.ADD_CUSTOMIZER_WISHLIST()),l=c.wishlistUrl;break;case"cart":n?(r=jse.libs.template.events.ADD_CUSTOMIZER_CART(),l=c.addCartCustomizerUrl):l=c.addCartUrl;break;case"price_offer":return o.attr("action",c.priceOfferUrl).attr("method",c.priceOfferMethod),o.off("submit"),void o.submit();default:setTimeout(function(){a.trigger(jse.libs.template.events.STICKYBOX_CONTENT_CHANGE())},250)}if(r){var g=$.Deferred();g.done(function(e){h[e]=0,p(h,o,l,i)}).fail(function(){u(i,"-fail")}),s.trigger(r,[{deferred:g,dataset:h}])}else l&&p(h,o,l,i)}}).fail(function(){u(i,"-fail")})}},m=function(e){clearTimeout(o),o=setTimeout(function(){g.call(this,e)}.bind(this),300)};return l.init=function(e){var s=t.find("form");s.on("submit",{target:"cart"},g).on("click",c.wishlistButtons,{target:"wishlist"},g).on("click",c.priceOfferButtons,{target:"price_offer"},g).on("change",c.attributes,{target:"check"},g).on("blur",c.quantity,{target:"check"},function(e){g(e)}).on("keyup",c.quantity,{target:"check"},m),s.not(".no-status-check").each(function(){g.call($(this))}),e()},l});