"use strict";gambio.widgets.module("menu",[gambio.source+"/libs/events",gambio.source+"/libs/responsive",gambio.source+"/libs/interaction"],function(e){var t=$(this),n=$(window),a=$("body"),o=null,i=null,s=null,l=null,r=null,c=null,u=null,d=null,v=null,p=null,f=!1,h=null,m=null,b=!1,g=!1,C=null,T=null,w={},y=Modernizr.touchevents||navigator.userAgent.search(/Touch/i)!==-1,k={menuType:"horizontal",unfoldLevel:0,accordion:!1,showAllLink:!1,breakpoint:40,enterDelay:0,leaveDelay:50,widthTolerance:10,openClass:"open",switchElementPosition:!0,ignoreClass:"ignore-menu",touchMoveTolerance:10,openActive:!1,events:{desktop:["touch","hover"],mobile:["touch","click"]}},I=$.extend({},k,e),N={},D=function(){T=T||C;var e=Math.abs(T.event.originalEvent.pageY-C.event.originalEvent.pageY);return T=null,e>I.touchMoveTolerance},O=function(){o=t.children("ul"),i=o.children().not(".navbar-topbar-item"),s=i.filter(".dropdown-more"),l=s.children("ul"),c=i.filter(".custom"),r=i.not(s),u=r.not(c)},E=function(e,t){var n=e.data("position"),a=!1;t.children().each(function(){var t=$(this),o=t.data("position");if(o>n)return t.before(e.detach()),a=!0,!1}),a||t.append(e)},P=function(e){var t=!1,n=function(n){n.each(function(){var n=$(this),a=n.data().width;return e>a?(E(n,o),void(e-=a)):(t=!0,!1)})};O(),n(l.children(".custom")),t||n(l.children());var a=0;l.children().each(function(){a+=$(this).data().width}),0===a?s.hide():a<s.data().width+e&&(s.hide(),e+=s.data().width,n(l.children()))},j=function(e){var t=!1,n=function(n){n.each(function(){var n=$(this),a=n.data().width;if(n.filter("."+I.openClass).add(n.find("."+I.openClass)).removeClass(I.openClass),E(n,l),e-=a,e<0)return t=!0,!1})};O(),s.is(":hidden")&&(e+=s.data().width,s.removeClass("style"),s.show()),n($(u.get().reverse())),t||n($(c.get().reverse()))},S=function(){i.each(function(e){var t=$(this),n=t.outerWidth();t.data({width:n,position:e})})},A=function(){t.find("li."+I.openClass).each(function(){return $(this).parents(".navbar-categories-left").length>0||void $(this).removeClass(I.openClass)})},R=function(){h=h?clearTimeout(h):null,m=m?clearTimeout(m):null},_=function(){t.css({overflow:"visible",height:"auto"})},M=function(){var e=o.width(),t=i.filter("."+I.openClass).children("ul");t.each(function(){var t=$(this),n=t.parent();n.removeClass("flyout-right flyout-left flyout-center flyout-wont-fit");var a=t.outerWidth(),o=n.position().left,i=n.outerWidth();e>o+a?n.addClass("flyout-right"):o+i-a>0?n.addClass("flyout-left"):a<e?n.addClass("flyout-center"):n.addClass("flyout-wont-fit")})},U=function(e,n){var a=t.innerWidth()-I.widthTolerance,i=0;"horizontal"!==I.menuType||v===a&&"switchedToDesktop"!==n||(o.children(":visible").each(function(){i+=$(this).data("width")}),a<i?j(i-a):P(a-i),M(),v=a)},z=function(){v=-1,P(99999999),$(".level-1").css("padding-bottom","200px"),"vertical"===I.menuType&&($("#categories nav.navbar-default:first").not(".nav-categories-left").length>0&&$("#categories nav.navbar-default:first").css({opacity:0,height:0}).children().hide(),t.find("ul.level-1 li.navbar-topbar-item:first").before($("#categories nav.navbar-default li.topmenu-content").detach()),t.appendTo("#categories > .navbar-collapse"),t.addClass("navbar-default navbar-categories"),t.find("ul.level-1").addClass("navbar-nav"),t.find(".navbar-topbar-item").not(".topbar-search").show(),G(),a.trigger(jse.libs.template.events.MENU_REPOSITIONED(),["switchedToMobile"]))},F=function(){if($(".level-1").css("padding-bottom",""),"vertical"===I.menuType){$("#categories nav.navbar-default:first").not(".nav-categories-left").length>0&&$("#categories nav.navbar-default:first").css({opacity:1,height:"auto"}).children().show();var e=t.find("li.topmenu-content").detach();$("#categories nav.navbar-default ul.level-1:first").append(e),t.appendTo(".box-categories"),t.removeClass("navbar-default navbar-categories"),t.find("ul.level-1").removeClass("navbar-nav"),t.find(".navbar-topbar-item").hide(),J(),a.trigger(jse.libs.template.events.MENU_REPOSITIONED(),["switchedToDesktop"])}b||(S(),b=!0),"horizontal"===I.menuType&&(U(),y&&(o.find(".enter-category").show(),o.find(".dropdown > a").click(function(e){e.preventDefault()})))},x=function(e,t){e.removeClass("touch mouse").addClass(t||"")},H=function(){var e=p||{},t=jse.libs.template.responsive.breakpoint();if(t.id!==e.id){var n=t.id<=I.breakpoint&&(!f||void 0===e.id),a=t.id>I.breakpoint&&(f||void 0===e.id);f=t.id<=I.breakpoint,p=$.extend({},t),n||a?(R(),"vertical"!==I.menuType&&A(),I.switchElementPosition?n?z():F():M()):!f&&I.switchElementPosition?U():f||M()}},L=function(e,n,a){var i=$(this),s=i.children("ul"),l=s.length,r=s.length?s.data("level")||"0":99,c=parseInt(r,10)<=2&&p.id>I.breakpoint||p.id<=I.breakpoint;if("mobile"===n&&e.stopPropagation(),l&&c)if(e.preventDefault(),"mobile"===n)i.toggleClass(I.openClass);else{var u=i.hasClass(I.openClass),d=i.hasClass("leave"),v=e.data&&e.data.action?e.data.action:u&&d?"enter":u?"leave":"enter";switch(v){case"enter":g||jse.libs.template.interaction.isMouseDown()||(g=!0,R(),h=setTimeout(function(){o.find("."+I.openClass).not(i).not(i.parentsUntil(t,"."+I.openClass)).trigger(jse.libs.template.events.TRANSITION_STOP(),[]).removeClass(I.openClass),o.find(".leave").trigger(jse.libs.template.events.TRANSITION_STOP(),[]).removeClass("leave"),w.open=!0,i.off(jse.libs.template.events.TRANSITION_FINISHED()).one(jse.libs.template.events.TRANSITION_FINISHED(),function(){g=!1}).trigger(jse.libs.template.events.TRANSITION(),w).trigger(jse.libs.template.events.OPEN_FLYOUT(),[t]),M()},"number"==typeof a?a:I.enterDelay));break;case"leave":g=!1,R(),i.addClass("leave"),m=setTimeout(function(){w.open=!1,o.find("."+I.openClass).not(i.parentsUntil(t,"."+I.openClass)).off(jse.libs.template.events.TRANSITION_FINISHED()).one(jse.libs.template.events.TRANSITION_FINISHED(),function(){x(i,""),i.removeClass("leave")}).trigger(jse.libs.template.events.TRANSITION(),w)},"number"==typeof a?a:I.leaveDelay)}}},W=function(e){var t=$(this),n=p.id<=I.breakpoint?"mobile":"desktop",a=I.events&&I.events[n]?I.events[n]:[];x(t,"mouse"),$.inArray(e.data.event,a)>-1&&L.call(t,e,n,e.data.delay),(t.hasClass("custom")||y&&0==t.children("ul").length)&&"click"===e.data.event&&!t.find("form").length&&(e.preventDefault(),e.stopPropagation(),"_blank"===t.find("a").attr("target")?window.open(t.find("a").attr("href")):location.href=t.find("a").attr("href"))},Y=function(e){e.stopPropagation();var t=$(this),a=p.id<=I.breakpoint?"mobile":"desktop",i=I.events&&I.events[a]?I.events[a]:[];o.find(".enter-category").show(),o.find(".dropdown > a").on("click",function(e){e.preventDefault()}),"start"===e.data.type?(C={event:e,timestamp:(new Date).getTime(),top:n.scrollTop()},o.off("mouseenter.menu mouseleave.menu")):$.inArray("touch",i)>-1&&!D(e)&&(x(t,"touch"),$.inArray("hover",i)!==-1&&"pointerdown"===d.start||L.call(t,e,a),o.on("mouseleave",function(){o.on("mouseenter.menu","li",{event:"hover"},W).on("mouseleave.menu","li",{event:"hover",action:"leave"},W)}))},B=function(e){T={event:e,timestamp:(new Date).getTime(),top:n.scrollTop()}},K=function(e,n){n!==t&&0===t.find($(e.target)).length&&(R(),"horizontal"===I.menuType&&o.find(".touch, .mouse, .leave, ."+I.openClass).removeClass("touch mouse leave "+I.openClass))},q=function(e){e.preventDefault(),e.stopPropagation(),$(this).parents(".navbar-topbar-item").length>0||($(this).hasClass("dropdown")?$(this).hasClass(I.openClass)?$(this).removeClass(I.openClass).find("."+I.openClass).removeClass(I.openClass):$(this).addClass(I.openClass).parentsUntil(t,"li").addClass(I.openClass):location.href=$(this).find("a").attr("href"))},G=function(){o.on(d.start+".menu","li",{type:"start"},Y).on(d.move+".menu","li",{type:"start"},B).on(d.end+".menu","li",{type:"end"},Y).on("click.menu","li",{event:"click",delay:0},W).on("mouseenter.menu","li",{event:"hover",action:"enter"},W).on("mouseleave.menu","li",{event:"hover",action:"leave"},W),a.on(jse.libs.template.events.MENU_REPOSITIONED(),U)},J=function(){o.off(d.start+".menu","li").off(d.move+".menu","li").off(d.end+".menu","li").off("click.menu","li").off("mouseenter.menu","li").off("mouseleave.menu","li")};return N.init=function(e){if(d=jse.core.config.get("touch"),w.classOpen=I.openClass,O(),_(),a.on(jse.libs.template.events.BREAKPOINT(),H).on(jse.libs.template.events.OPEN_FLYOUT()+" click "+d.end,K),$(".close-menu-container").on("click",function(e){e.stopPropagation(),e.preventDefault()}),$(".close-flyout").on("click",A),"horizontal"===I.menuType&&G(),"vertical"===I.menuType&&(I.accordion===!0&&t.on("click","li",q),0===$("#categories").length)){var n='<div id="categories"><div class="navbar-collapse collapse"><nav class="navbar-default navbar-categories hidden"></nav></div></div>';$("#header").append(n)}if(H(),t.find("."+I.ignoreClass).on("mouseleave.menu mouseenter.menu click.menu "+d.start+" "+d.end,"li",function(e){e.stopPropagation()}),I.openActive){var o=t.find(".active");o.parentsUntil(t,"li").addClass("open")}$("li.custom-entries a").on("click",function(e){e.stopPropagation()});var i=p.id<=I.breakpoint?"mobile":"desktop";"mobile"==i&&$(".level-1").css("padding-bottom","200px"),e()},N});