"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};gambio.widgets.module("product_cart_handler",["form","xhr",gambio.source+"/libs/events",gambio.source+"/libs/modal.ext-magnific",gambio.source+"/libs/modal"],function(e){var t=$(this),n=$(window),a=$("body"),i=null,r=null,o=null,s=null,l=null,d=null,c=null,u=null,f=!1,p=null,h={},g=!1,m={ajax:!0,confirmDelete:!1,deleteInput:"#field_cart_delete_products_id",updateTarget:".shipping-calculation",checkUrl:"shop.php?do=CheckQuantity",updateUrl:"shop.php?do=Cart",changeClass:"has-changed",errorClass:"error",cartEmpty:".cart-empty",cartNotEmpty:".cart-not-empty",classLoading:"loading",actions:{add:"wishlist_to_cart","delete":"update_product",refresh:"update_wishlist"},ajaxActions:{add:"shop.php?do=WishList/AddToCart","delete":"shop.php?do=Cart/Delete",refresh:"shop.php?do=Cart/Update"},selectorMapping:{buttons:".shopping-cart-button",giftContent:".gift-cart-content-wrapper",giftLayer:".gift-cart-layer",shareContent:".share-cart-content-wrapper",shareLayer:".share-cart-layer",hiddenOptions:"#cart_quantity .hidden-options",message:".global-error-messages",infoMessage:".info-message",shippingInformation:"#shipping-information-layer",totals:"#cart_quantity .total-box",errorMsg:".error-msg",submit:".button-submit"}},v=$.extend(!1,{},m,e),b={},y=function(e){v.ajax?c=v.ajaxActions[e]:v.actions&&v.actions[e]&&(c=c.replace(/(action=)[^\&]+/,"$1"+v.actions[e]),i.attr("action",c))},_=function(e){e.find('input[type="text"]').each(function(){var e=$(this),t=e.val();e.data("oldValue",t)})},C=function(e){var t=e&&e.length?e:i,n=e&&e.length?e:i.find(".order-wishlist .item:gt(0)"),a=i.find('.hidden-options input[type="hidden"]'),r=jse.libs.form.getData(t),o=[],s=null;return $.each(r.products_id,function(e,t){s={},s.target=n.eq(e),$.each(r,function(t,n){"object"===("undefined"==typeof n?"undefined":_typeof(n))&&void 0!==n[e]&&(s[t]=[n[e]])}),a.filter('[name^="id['+t+'"], .force').each(function(){var e=$(this),t=e.attr("name");s[t]=e.val()}),o.push(s)}),o},j=function(e,t,n){var a=[],i=!1;return n=n||C(),$.each(n,function(){var e=this.target.find("."+v.changeClass);return i=i||!!e.length,!i}),$.when.apply(void 0,a).promise()},T=function(e,t){return delete h["product_"+e],t.removeClass("loading"),h},x=function(e,n,i){jse.libs.template.helpers.fill(n.content,a,v.selectorMapping),$(".info-message").toggleClass("hidden",""===$(".info-message").text()),r.trigger(jse.libs.template.events.CART_UPDATED(),[]),a.trigger(jse.libs.template.events.CART_UPDATE(),"add"===i),_(e),$.isEmptyObject(n.products)?(l.addClass("hidden"),s.removeClass("hidden")):(s.addClass("hidden"),l.removeClass("hidden")),window.gambio.widgets.init(t)},E=function(e,t,n,a,r){if(v.ajax)delete n.target,e.trigger(jse.libs.template.events.TRANSITION(),p),jse.libs.xhr.ajax({url:c,data:n},!0).done(function(e){jse.libs.hooks.execute(jse.libs.hooks.keys.shop.cart.change,{$target:t,dataset:n,article:a,type:r,result:e},500);var i=$(e.products["product_"+a]||"");i.removeClass(v.classLoading),t.replaceWith(i),x(t,e,r);var o=a.match(/\d+/)[0],s=$('input[value^="'+o+'"]').parent("td");s.each(function(){if(!$(this).find('input[value="'+a+'"]').length){var n=$(this).find('input[id="products_id[]"]').attr("value");i=$(e.products["product_"+n]||""),t=$(this).parent("tr"),t.replaceWith(i)}})}).always(function(){T(a,e)});else{var o=$.Deferred();o.always(function(){T(a,e)}),i.trigger("submit",o)}},w=function(){var e=$(this),t=e.val(),n=e.data().oldValue,a=t!==n;a?(g=a,e.addClass(v.changeClass)):e.removeClass(v.changeClass),R()},k=function(){var e=$(this),t=e.val(),n=e.data().oldValue,a=t!==n;a&&e.closest(".item").find(".button-refresh").first().trigger("click")},D=function(e){e.preventDefault(),e.stopPropagation();var t=$(this),n=t.closest(".item"),i=e.data.type,r=C(n)[0],s=r.products_id[0],l=r.target;l.find(".product-title").text();if(n.addClass("loading"),$.isEmptyObject(h)||v.ajax&&!h["product_"+s])switch(h["product_"+s]=!0,y(i),i){case"delete":if(o.val(s),r[d]=[s],v.confirmDelete){var c=jse.core.lang.translate("CART_WISHLIST_DELETE_TITLE","general"),u=jse.core.lang.translate("CART_WISHLIST_DELETE","general");jse.libs.template.modal.confirm({content:u,title:c}).done(function(){var e=$.Deferred();e.done(function(){E(n,l,r,s,i)}),a.trigger(jse.libs.template.events.WISHLIST_CART_DELETE(),[{deferred:e,dataset:r}])}).fail(function(){T(s,n)})}else{var f=$.Deferred();f.done(function(){E(n,l,r,s,i)}),a.trigger(jse.libs.template.events.WISHLIST_CART_DELETE(),[{deferred:f,dataset:r}])}break;default:j(!1,!1,[$.extend(!0,{},r)]).done(function(){o.val("");var e=null;if("add"===i&&(e=jse.libs.template.events.WISHLIST_TO_CART()),e){var t=$.Deferred();t.done(function(){E(n,l,r,s,i)}),a.trigger(e,[{deferred:t,dataset:r}])}else E(n,l,r,s,i)}).fail(function(){T(s,n)})}},I=function(e,t){if(e.preventDefault(),e.stopPropagation(),!t&&e.originalEvent){var n=$(e.originalEvent.explicitOriginalTarget);n.length&&n.is('input[type="text"]')&&n.closest(".item").find(".button-refresh").first().trigger("click")}else t&&j().done(function(){i.off("submit").trigger("submit"),"object"===("undefined"==typeof t?"undefined":_typeof(t))&&t.resolve()}).fail(function(){"object"===("undefined"==typeof t?"undefined":_typeof(t))&&t.reject()})},L=function(e){if(e.preventDefault(),e.stopPropagation(),g){var t=C();return $.each(t,function(){var e=this.target.find("."+v.changeClass);e&&e.closest(".item").find(".button-refresh").first().trigger("click")}),g=!1,void R()}var n=$(this),a=n.attr("href");!$.isEmptyObject(h)||u||f||(u=!0,j(!0,!0).done(function(){function t(){location.href=a}jse.libs.hooks.execute(jse.libs.hooks.keys.shop.cart.checkout,{event:e},500).then(t)["catch"](t)}).always(function(){u=!1}))},S=function(e,t){e.stopPropagation(),t=t||{},j(t.showChanges,t.revertChanges).done(function(){t.deferred&&t.deferred.resolve()}).fail(function(){t.deferred&&t.deferred.reject()})},A=function(){f=!0,jse.libs.xhr.ajax({url:v.updateUrl},!0).done(function(e){var t=i.find(".order-wishlist .item").first(),n=$();$.each(e.products,function(e,a){var r=e.replace("product_",""),o=i.find('input[name="products_id[]"][value="'+r+'"]'),s=null;if(o.length){s=o.closest(".item");var l=s.find('input[name="cart_quantity[]"]'),d=parseFloat(l.data().oldValue),c=parseFloat(l.val()),u=parseFloat($(a).find('input[name="cart_quantity[]"]').val());l.data("oldValue",u),d===c&&c!==u?l.addClass(v.changeClass):d!==c&&c===u&&l.removeClass(v.changeClass)}else s=$(a),s.insertAfter(t);n.add(s),t=s}),x(n,e)}).always(function(){f=!1})},R=function(){i.find(v.selectorMapping.submit).text(jse.core.lang.translate(g?"refresh":"checkout","buttons"))};return b.init=function(e){r=$(v.updateTarget),s=$(v.cartEmpty),l=$(v.cartNotEmpty),o=$(v.deleteInput),i=t.find("form").first(),d=o.attr("name"),c=i.attr("action"),p={open:!0,classOpen:v.classLoading},_(i),i.on("input",'input[type="text"]',w).on("blur",'input[type="text"]',k).on("click.delete",".button-delete",{type:"delete"},D).on("click.refresh",".button-refresh",{type:"refresh"},D).on("click.addtocart",".button-to-cart",{type:"add"},D).on("click.submit",".button-submit",{type:"submit"},L).on("submit",I).on(jse.libs.template.events.CHECK_CART(),S),v.updateUrl&&n.on("focus",A),e()},b});